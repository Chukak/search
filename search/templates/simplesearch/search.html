{% extends 'base.html' %}

{% block title %}Search{% endblock title %}


{% block content %}
<form method="get" action="." style="margin: 0">
    <input  id="search_box" type="text" name="search_box"  placeholder="Search..." >
    <label for="author">author</label>
    <input id="author" type="checkbox">
    <label for="text_all"> All text</label>
    <input  id="text_all" type="checkbox" name="text_all">

    <select id="years">
            <option class="active">ALL</option>
        {% for year in years %}
            <option>{{ year }}</option>
        {% endfor %}
    </select>
    <input id="search_submit" type="submit" name="button" value="Search">
</form>
<div id="await">

</div>
<input type="submit" id="load_more" value="Load more">
{% endblock content %}
{% block script %}
<script>
    var socket = new WebSocket('ws://' + window.location.host + '');

    socket.onopen = function open() {
      console.log('WebSockets connection created.');
    };

    socket.onmessage = function(e) {
        //console.log(e.data)
        var data = JSON.parse(e.data)
        console.log(data)
        for (o in data) {
        var obj = data[o]
        $('div#await').append('<h2>' + obj['fields']['title'] + '</h2>' +
        '<textarea>' + obj['fields']['text'] + '</textarea>' +
        '<p>' + obj['fields']['date_created'] + '</p>' +
        '<hr>')
        }

    };


    $('#search_submit').click(function(event) {
        $('div#await').empty()
        event.preventDefault()
        var author = false
        var text_all = false
        if ($('input#author').is(':checked')) {
            author = true
        }

        if ($('input#text_all').is(':checked')) {
            text_all = true
        }

        socket.send(JSON.stringify({
            'action': 'search',
            'text': $('input#search_box').val(), 'author': author,
            'text_all': text_all, 'date': $('select#years').val(),
            }))
        });
    $('#load_more').click(function(event) {
        event.preventDefault()
        socket.send(JSON.stringify({
            'action': 'more',
        }))
    });

    if (socket.readyState == WebSocket.OPEN) {
      socket.onopen();
    };
</script>
{% endblock script %}

